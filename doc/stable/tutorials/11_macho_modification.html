<!doctypehtml><html data-content_root=../ lang=en><meta charset=utf-8><meta content=width=device-width,initial-scale=1.0 name=viewport><meta content=width=device-width,initial-scale=1 name=viewport><meta content=width=device-width,initial-scale=1 name=viewport><meta content=ie=edge http-equiv=x-ua-compatible><meta content="Copy to clipboard"name=lang:clipboard.copy><meta content="Copied to clipboard"name=lang:clipboard.copied><meta content=en name=lang:search.language><meta content=True name=lang:search.pipeline.stopwords><meta content=True name=lang:search.pipeline.trimmer><meta content="No matching documents"name=lang:search.result.none><meta content="1 matching document"name=lang:search.result.one><meta content="# matching documents"name=lang:search.result.other><meta content=[\s\-]+ name=lang:search.tokenizer><meta content="LIEF Documentation"name=Description><link crossorigin href=https://fonts.gstatic.com/ rel=preconnect><script src=../_static/javascripts/vendor.min.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css rel=stylesheet><link href=../_static/favicon.ico rel=apple-touch-icon><title>11 - Mach-O Modification — LIEF Documentation</title><link href=../_static/fonts/material-icons.css rel=stylesheet><link href=../_static/stylesheets/vendor.min.css rel=stylesheet><link href=../_static/pygments.css?v=3d3fbe02 rel=stylesheet><link href=../_static/basic.css?v=fb9458d3 rel=stylesheet><link href=../_static/graphviz.css?v=fd3f3429 rel=stylesheet><link href=../_static/css/custom.css?v=49aeed65 rel=stylesheet><script src=../_static/documentation_options.js?v=81998473></script><script src=../_static/doctools.js?v=9a2dae69></script><script src=../_static/sphinx_highlight.js?v=dc90522c></script><link href=../_static/favicon.ico rel=icon><link href=../genindex.html rel=index title=Index><link href=../search.html rel=search title=Search><link title="12 - ELF Coredump"href=12_elf_coredump.html rel=next><link title="10 - Android formats"href=10_android_formats.html rel=prev><link href=../_static/stylesheets/theme.css rel=stylesheet><body data-md-color-accent=cyan data-md-color-primary=blue dir=ltr><nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom fixed-top"role=navigation><a class=navbar-brand href=../index.html>LIEF Documentation</a><button class=navbar-toggler data-target=#navbar-collapse data-toggle=collapse><span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse justify-content-center mt-2 mt-lg-0"id=navbar-collapse><ul class="navbar-nav position-relative px-lg-6 px-xl-8"><li class=nav-item><a class=nav-link href=https://lief.re> <i class="fa-solid fa-house mr-3"></i>Home </a><li class=nav-item><a class=nav-link href=https://lief.re/blog> <i class="fa-solid fa-rss mr-3"></i>Blog </a><li class=nav-item><a class=nav-link href=https://lief.re/download> <i class="fa-solid fa-download mr-3"></i>Download </a><li class="nav-item dropdown"><a class="nav-link dropdown-toggle"aria-expanded=false data-toggle=dropdown href=# role=button> <i class="fa-solid fa-book mr-3"></i>Documentation </a> <div class=dropdown-menu role=menu><a class=dropdown-item href=https://lief.re/doc/stable/doxygen>Doxygen</a></div><li class=nav-item><a class=nav-link href=https://lief.re/about> <i class="fa-solid fa-bars-staggered mr-3"></i>About </a><li class="nav-item ml-lg-3 mt-3 mt-lg-0"><a class="hover-lift-light mt-1"href=https://discord.gg/jGQtyAYChJ target=_blank> <i class="fab fa-2x fa-discord text-darkblue mr-3"></i> </a><li class=nav-item><a class="btn btn-outline-pink"href=https://github.com/sponsors/lief-project target=_blank> <i class="fa-solid fa-heart mr-3"></i> Sponsor </a></ul></div></nav><div class="container-fluid container-docs"><div class=row><div class="col-12 col-lg-3 col-xl-2 border-lg-right py-lg-5 pl-lg-4 docs-sidebar docs-sidebar-left"><div class="collapse d-lg-block mb-6 mb-lg-0"id=sidebar-collapse><form action=../search.html method=GET name=search><input autocapitalize=off autocomplete=off class=form-control data-md-component=query data-md-state=active name=q placeholder=Search spellcheck=false></form><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../intro.html><em class="fa fa-solid fa-door-open"></em> Introduction</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../installation.html><em class="fa fa-solid fa-gears"></em> Installation and Integration</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../compilation.html><em class="fa fa-solid fa-laptop-code"></em> Compilation</a></ul><div class="text-darkblue text-uppercase font-size-normal font-weight-bolder mt-4 pt-2 mb-2"><span class=caption-text><i class="fa-solid fa-sitemap"> </i>Formats</span></div><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../formats/elf/index.html><em class="fa fa-brands fa-linux"></em> ELF</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../formats/macho/index.html><em class="fa fa-brands fa-apple"></em> Mach-O</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../formats/pe/index.html><em class="fa fa-brands fa-windows"></em> PE</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../formats/android/index.html><em class="fa fa-brands fa-android"></em> Android</a></ul><div class="text-darkblue text-uppercase font-size-normal font-weight-bolder mt-4 pt-2 mb-2"><span class=caption-text><i class="fa-solid fa-code"> </i>API</span></div><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../api/binary_abstraction/index.html><em class="fa fa-brands fa-uncharted"></em> Binary Abstraction</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../api/utilities/index.html><em class="fa fa-solid fa-hand-holding-hand"></em> Utilities</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../api/error_handling/index.html><em class="fa fa-solid fa-triangle-exclamation"></em> Error Handling</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../api/logging/index.html><em class="fa fa-regular fa-rectangle-list"></em> Logging</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../api/cpp/index.html><em class="fa fa-regular fa-file-code"></em> C++</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../api/rust/index.html><em class="fa fa-brands fa-rust"></em> Rust</a></ul><div class="text-darkblue text-uppercase font-size-normal font-weight-bolder mt-4 pt-2 mb-2"><span class=caption-text><i class="fa-solid fa-hat-wizard"> </i>LIEF Extended</span></div><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../extended/intro.html><em class="fa fa-cubes"></em> What is LIEF Extended?</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../extended/debug_info/index.html><em class="fa fa-solid fa-magnifying-glass"></em> Debug Info</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../extended/dwarf/index.html><em class="fa fa-solid fa-bars-staggered"></em> DWARF</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../extended/pdb/index.html><em class="fa fa-brands fa-windows"></em> PDB</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../extended/objc/index.html><em class="fa fa-brands fa-apple"></em> Objective-C</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../extended/dsc/index.html><em class="fa fa-solid fa-diagram-predecessor"></em> Dyld Shared Cache</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../extended/disassembler/index.html><em class="fa fa-solid fa-dna"></em> Disassembler</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../extended/assembler/index.html><em class="fa fa-solid fa-user-secret"></em> Assembler</a></ul><div class="text-darkblue text-uppercase font-size-normal font-weight-bolder mt-4 pt-2 mb-2"><span class=caption-text><i class="fa-solid fa-layer-group"> </i>Tutorials</span></div><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=01_play_with_formats.html>01 - Parse and manipulate formats</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=02_pe_from_scratch.html>02 - Create a PE from scratch</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=03_elf_change_symbols.html>03 - Play with ELF symbols</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=04_elf_hooking.html>04 - ELF Hooking</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=05_elf_infect_plt_got.html>05 - Infecting the plt/got</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=06_pe_hooking.html>06 - PE Hooking (Deprecated)</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=07_pe_resource.html>07 - PE Resources</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=08_elf_bin2lib.html>08 - Transforming an ELF executable into a library</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=09_frida_lief.html>09 - How to use frida on a non-rooted device</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=10_android_formats.html>10 - Android formats</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=#>11 - Mach-O Modification</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=12_elf_coredump.html>12 - ELF Coredump</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=13_pe_authenticode.html>13 - PE Authenticode</a></ul><div class="text-darkblue text-uppercase font-size-normal font-weight-bolder mt-4 pt-2 mb-2"><span class=caption-text><i class="fa-brands fa-space-awesome"> </i>Extra Information</span></div><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../references.html><em class="fa fa-fa-solid fa-book-bookmark"></em> References</a></ul><ul class="list-unstyled mt-3"><li><a class="text-darkblue font-size-sm d-block mb-2"href=../changelog.html><em class="fa fa-solid fa-code-compare"></em> Changelog</a></ul></div><hr><span class="svg-icon text-purple mr-1 relative-top--1"> <svg viewbox="0 0 512 512"height=512 width=512 xmlns=http://www.w3.org/2000/svg><title>ionicons-v5-d</title><circle cx=160 cy=96 r=48 style=fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px></circle><circle cx=160 cy=416 r=48 style=fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px></circle><line style=fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px x1=160 x2=160 y1=368 y2=144></line><circle cx=352 cy=160 r=48 style=fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px></circle><path d=M352,208c0,128-192,48-192,160 style=fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px></path></svg> </span><a class=text-darkblue href=https://github.com/lief-project/LIEF/commits/10f74acf>0.16.4 (10f74acf)</a><br> Updated on 23/02/2025, 07:31:52.</div><div class="col-12 col-lg-9 col-xl-8 offset-lg-3 offset-xl-2 py-lg-5 px-lg-6 mb-8"><nav aria-label=breadcrumb><ol class=breadcrumb><li class=breadcrumb-item><a aria-label=Home href=../index.html><i class="fa-solid fa-home"></i></a><li class="breadcrumb-item active"aria-current=page><a href=#>11 - Mach-O Modification</a></ol></nav><section id=mach-o-modification><h1 id=tutorials-11-macho-modification--page-root>11 - Mach-O Modification<a title="Link to this heading"class=headerlink href=#tutorials-11-macho-modification--page-root>¶</a></h1><p>This tutorial deals with Mach-O format modification and introduces some internal aspects of the format.<p>Files and scripts used in this tutorial are available on the <a class="reference external"href=https://github.com/lief-project/tutorials/tree/master/11_macho_modification>tutorials repository</a><p>By Romain Thomas - <a class="reference external"href=https://twitter.com/rh0main>@rh0main</a><hr class=docutils><section id=introduction><h2 id=introduction>Introduction<a title="Link to this heading"class=headerlink href=#introduction>¶</a></h2><p>A basic Mach-O binary (i.e. not FAT) can be represented in fours parts that are described in this diagram:<figure class=align-center><img alt=../_images/image1.png src=../_images/image1.png></figure><p>The first part begins with a header that can be accessed through the <a class="reference internal"href=../formats/macho/python.html#lief.MachO.Binary.header title=lief.MachO.Binary.header><code class="xref py py-attr docutils literal notranslate"><span class=pre>lief.MachO.Binary.header</span></code></a> attribute. In the second part, we have the load commands table which can be iterated using <code class="xref py py-attr docutils literal notranslate"><span class=pre>lief.MachO.Binary.load_commands</span></code> then, we can optionally have padding or free space. Finally, we have the raw data (assembly code, rebase bytecode, signature, …)<p>Load commands like <a class="reference internal"href=../formats/macho/python.html#lief.MachO.SegmentCommand title=lief.MachO.SegmentCommand><code class="xref py py-class docutils literal notranslate"><span class=pre>SegmentCommand</span></code></a> or <a class="reference internal"href=../formats/macho/python.html#lief.MachO.DyldInfo title=lief.MachO.DyldInfo><code class="xref py py-class docutils literal notranslate"><span class=pre>DyldInfo</span></code></a> can be associated with <em>raw data</em> that are located after the load command table and the padding section. The padding section is used by OSX to sign the binary after the compilation by adding a custom command. The <code class="docutils literal notranslate"><span class=pre>codesign</span></code> utility extends the <em>raw data</em> area with the signature and adds a <code class="docutils literal notranslate"><span class=pre>LC_CODE_SIGNATURE</span></code> or a <code class="docutils literal notranslate"><span class=pre>LC_DYLIB_CODE_SIGN_DRS</span></code> command in the padding area.<p>Since load commands are the base unit of the Mach-O format – segments, shared libraries, entry point, etc are somehow <em>commands</em> – being able to add arbitrary commands in a binary enables interesting like code injection, anti-analysis, …<p>Different techniques exist to add new command in a Mach-O binary:<ul class=simple><li><p>One can replace an existing load command that is not mandatory for the execution like <a class="reference internal"href=../formats/macho/python.html#lief.MachO.UUIDCommand title=lief.MachO.UUIDCommand><code class="xref py py-class docutils literal notranslate"><span class=pre>UUIDCommand</span></code></a> or <a class="reference internal"href=../formats/macho/python.html#lief.MachO.CodeSignature title=lief.MachO.CodeSignature><code class="xref py py-class docutils literal notranslate"><span class=pre>CodeSignature</span></code></a>.<li><p>One can use the padding area add to the command header.</ul><p>The main limitation of these techniques is that the size and the number of commands that can be added are tied to the padding section size or to the size of the command replaced.<p>If the padding size is tiny, we can’t add a <code class="docutils literal notranslate"><span class=pre>LOAD_DYLIB</span></code> command with a <em>very long</em> library path. Moreover <code class="docutils literal notranslate"><span class=pre>codesign</span></code> may complain that there are not enough spaces to add the <code class="docutils literal notranslate"><span class=pre>LC_CODE_SIGNATURE</span></code> since we are using the space that was reserved for it.<p>Next parts are about format modifications and how we managed to address this limitation.</section><section id=when-pie-makes-thing-easier><h2 id=when-pie-makes-thing-easier>When PIE makes thing easier<a title="Link to this heading"class=headerlink href=#when-pie-makes-thing-easier>¶</a></h2><p>OSX and iOS executables are by default compiled with flags that make them position independent. Instructions generated by the compiler will use relative addressing associated with <em>rebase</em> information.<p>To simplify (not accurate), PIE binaries enable to <em>map</em> the raw data section at a random base address. The idea that is implemented in LIEF is that raw data section can be mapped at a random base address so it can also be shifted within the format.<figure class=align-center><img alt=../_images/image2.png src=../_images/image2.png></figure><p>Such transformation also requires to keep a consistent state of the format metadata. Especially, when we shift the raw data we need to update relocations, segment offsets, virtual address, etc. Once the raw data shifted and the metadata updated, we have an arbitrary space between the load command table and the raw data section. Thus we can extend the load command table as shown in figure below:<figure class=align-center><img alt=../_images/image3.png src=../_images/image3.png></figure><div class="admonition warning"><p class=admonition-title>Warning<p>The size of the shift must be aligned on a page size to avoid issues with section and segment alignments.</div><p>Keeping the format consistency after the shift transformation is not easy. The next part presents some parts of the Mach-O format that need to be updated in order to keep the consistency.</section><section id=when-mach-o-makes-thing-harder><h2 id=when-mach-o-makes-thing-harder>When Mach-O makes thing harder<a title="Link to this heading"class=headerlink href=#when-mach-o-makes-thing-harder>¶</a></h2><p>After the shift operation, we need to update several load commands of the Mach-O format:<ul class=simple><li><p><a class="reference internal"href=../formats/macho/python.html#lief.MachO.SymbolCommand.symbol_offset title=lief.MachO.SymbolCommand.symbol_offset><code class="xref py py-attr docutils literal notranslate"><span class=pre>lief.MachO.SymbolCommand.symbol_offset</span></code></a> / <a class="reference internal"href=../formats/macho/python.html#lief.MachO.SymbolCommand.strings_offset title=lief.MachO.SymbolCommand.strings_offset><code class="xref py py-attr docutils literal notranslate"><span class=pre>lief.MachO.SymbolCommand.strings_offset</span></code></a><li><p><a class="reference internal"href=../formats/macho/python.html#lief.MachO.DataInCode.data_offset title=lief.MachO.DataInCode.data_offset><code class="xref py py-attr docutils literal notranslate"><span class=pre>lief.MachO.DataInCode.data_offset</span></code></a>, <a class="reference internal"href=../formats/macho/python.html#lief.MachO.CodeSignature.data_offset title=lief.MachO.CodeSignature.data_offset><code class="xref py py-attr docutils literal notranslate"><span class=pre>lief.MachO.CodeSignature.data_offset</span></code></a>, <a class="reference internal"href=../formats/macho/python.html#lief.MachO.SegmentSplitInfo.data_offset title=lief.MachO.SegmentSplitInfo.data_offset><code class="xref py py-attr docutils literal notranslate"><span class=pre>lief.MachO.SegmentSplitInfo.data_offset</span></code></a><li><p><a class="reference internal"href=../formats/macho/python.html#lief.MachO.MainCommand.entrypoint title=lief.MachO.MainCommand.entrypoint><code class="xref py py-attr docutils literal notranslate"><span class=pre>lief.MachO.MainCommand.entrypoint</span></code></a><li><p><a class="reference internal"href=../formats/macho/python.html#lief.MachO.FunctionStarts.data_offset title=lief.MachO.FunctionStarts.data_offset><code class="xref py py-attr docutils literal notranslate"><span class=pre>lief.MachO.FunctionStarts.data_offset</span></code></a> / <a class="reference internal"href=../formats/macho/python.html#lief.MachO.FunctionStarts.functions title=lief.MachO.FunctionStarts.functions><code class="xref py py-attr docutils literal notranslate"><span class=pre>lief.MachO.FunctionStarts.functions</span></code></a><li><p><a class="reference internal"href=../formats/macho/python.html#lief.MachO.DynamicSymbolCommand title=lief.MachO.DynamicSymbolCommand><code class="xref py py-class docutils literal notranslate"><span class=pre>DynamicSymbolCommand</span></code></a><li><p><code class="xref py py-attr docutils literal notranslate"><span class=pre>lief.MachO.Section.offset</span></code> / <code class="xref py py-attr docutils literal notranslate"><span class=pre>lief.MachO.Section.virtual_address</span></code><li><p><code class="xref py py-attr docutils literal notranslate"><span class=pre>lief.MachO.SegmentCommand.offset</span></code> / <a class="reference internal"href=../formats/macho/python.html#lief.MachO.SegmentCommand.virtual_address title=lief.MachO.SegmentCommand.virtual_address><code class="xref py py-attr docutils literal notranslate"><span class=pre>lief.MachO.SegmentCommand.virtual_address</span></code></a><li><p>…</ul><p>We also need to update:<ul class=simple><li><p>Relocations<li><p>Binding information<li><p>Export information</ul><p>Whereas ELF and PE formats use some kinds of <code class="docutils literal notranslate"><span class=pre>struct</span></code> for internal storage of relocations and exports, Mach-O format uses a bytecode to <em>rebase</em> the binary. Export information are stored in a <a class="reference external"href=https://en.wikipedia.org/wiki/Trie>trie</a> data structure. The use of trie and bytecode reduces the binary size but it makes the update more difficult as we need to interpret and regenerate the bytecode.<section id=rebase-bytecode><h3 id=rebase-bytecode>Rebase bytecode<a title="Link to this heading"class=headerlink href=#rebase-bytecode>¶</a></h3><p>As mentioned in the previous part, recent Mach-O loader uses a bytecode to relocate (or rebase) the binary. Offset and size of the bytecode are given in <a class="reference internal"href=../formats/macho/python.html#lief.MachO.DyldInfo.rebase title=lief.MachO.DyldInfo.rebase><code class="xref py py-attr docutils literal notranslate"><span class=pre>lief.MachO.DyldInfo.rebase</span></code></a> attribute. Basically, bytecode is compound of <code class="xref py py-class docutils literal notranslate"><span class=pre>REBASE_OPCODES</span></code> that define addresses to relocate.<div class="admonition warning"><p class=admonition-title>Warning<p>One can notice that <a class="reference internal"href=../formats/macho/python.html#lief.MachO.Section title=lief.MachO.Section><code class="xref py py-class docutils literal notranslate"><span class=pre>Section</span></code></a> object has a <a class="reference internal"href=../formats/macho/python.html#lief.MachO.Section.relocation_offset title=lief.MachO.Section.relocation_offset><code class="xref py py-attr docutils literal notranslate"><span class=pre>relocation_offset</span></code></a> attribute. Actually, it seems to be only used for Mach-O object files (<code class="xref py py-attr docutils literal notranslate"><span class=pre>lief.MachO.FILE_TYPES.OBJECT</span></code>) or with an executable that uses an old version of the Mach-O loader.<p>This offset points to a list of relocation structures (not bytecode) for which the number is defined by <a class="reference internal"href=../formats/macho/python.html#lief.MachO.Section.numberof_relocations title=lief.MachO.Section.numberof_relocations><code class="xref py py-attr docutils literal notranslate"><span class=pre>numberof_relocations</span></code></a>.</div><p>To know which addresses need to be relocated, we have to interpret the bytecode.<p>The <a class="reference internal"href=../formats/macho/python.html#lief.MachO.DyldInfo.show_rebases_opcodes title=lief.MachO.DyldInfo.show_rebases_opcodes><code class="xref py py-attr docutils literal notranslate"><span class=pre>lief.MachO.DyldInfo.show_rebases_opcodes</span></code></a> attribute returns the bytecode as <em>pseudo code</em>:<div class="highlight-python notranslate"><div class=highlight><pre><span></span><span class=kn>import</span> <span class=nn>lief</span>
<span class=n>app</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=s2>"MachO64_x86-64_binary_id.bin"</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>app</span><span class=o>.</span><span class=n>dyld_info</span><span class=o>.</span><span class=n>show_rebases_opcodes</span><span class=p>)</span>
</pre></div></div><div class="highlight-text notranslate"><div class=highlight><pre><span></span>[SET_TYPE_IMM] Type: POINTER
[SET_SEGMENT_AND_OFFSET_ULEB] Segment Index := 2 (__DATA) Segment Offset := 0x20
[DO_REBASE_ULEB_TIMES]
  for i in range(26):
      rebase(POINTER, __DATA, 0x20)
      Segment Offset += 0x8 (0x28)

      rebase(POINTER, __DATA, 0x28)
      Segment Offset += 0x8 (0x30)

      rebase(POINTER, __DATA, 0x30)
      Segment Offset += 0x8 (0x38)

      rebase(POINTER, __DATA, 0x38)
      Segment Offset += 0x8 (0x40)

      rebase(POINTER, __DATA, 0x40)
      Segment Offset += 0x8 (0x48)
      ...
[DONE]
</pre></div></div><p>From the above output, we can see that the loader will rebase <strong>pointer</strong> in the <code class="docutils literal notranslate"><span class=pre>__DATA</span></code> segment at offset <code class="docutils literal notranslate"><span class=pre>0x20,</span> <span class=pre>0x28,</span> <span class=pre>0x38,</span> <span class=pre>...</span></code>.<p>For those who only care about which exact addresses are relocated, this output is not very user-friendly. LIEF also provides a <strong>representation</strong> of this bytecode by creating <a class="reference internal"href=../formats/macho/python.html#lief.MachO.Relocation title=lief.MachO.Relocation><code class="xref py py-class docutils literal notranslate"><span class=pre>lief.MachO.Relocation</span></code></a> object. They are the result of the <strong>interpretation</strong> of the bytecode.<p>The <a class="reference internal"href=../formats/macho/python.html#lief.MachO.Binary.relocations title=lief.MachO.Binary.relocations><code class="xref py py-attr docutils literal notranslate"><span class=pre>lief.MachO.Binary.relocations</span></code></a> attribute returns an iterator over <a class="reference internal"href=../formats/macho/python.html#lief.MachO.Relocation title=lief.MachO.Relocation><code class="xref py py-class docutils literal notranslate"><span class=pre>lief.MachO.Relocation</span></code></a> objects that <strong>model</strong> a relocation in a similar object as <a class="reference internal"href=../formats/elf/python.html#lief.ELF.Relocation title=lief.ELF.Relocation><code class="xref py py-class docutils literal notranslate"><span class=pre>lief.ELF.Relocation</span></code></a> and <a class="reference internal"href=../formats/pe/python.html#lief.PE.Relocation title=lief.PE.Relocation><code class="xref py py-class docutils literal notranslate"><span class=pre>lief.PE.Relocation</span></code></a>.<div class="highlight-python notranslate"><div class=highlight><pre><span></span><span class=k>for</span> <span class=n>relocation</span> <span class=ow>in</span> <span class=n>app</span><span class=o>.</span><span class=n>relocations</span><span class=p>:</span>
  <span class=nb>print</span><span class=p>(</span><span class=n>relocation</span><span class=p>)</span>
</pre></div></div><div class="highlight-text notranslate"><div class=highlight><pre><span></span>100002020 POINTER 64 DYLDINFO  __DATA.__la_symbol_ptr _err
100002028 POINTER 64 DYLDINFO  __DATA.__la_symbol_ptr _errx
100002030 POINTER 64 DYLDINFO  __DATA.__la_symbol_ptr _exit
100002038 POINTER 64 DYLDINFO  __DATA.__la_symbol_ptr _fprintf
100002040 POINTER 64 DYLDINFO  __DATA.__la_symbol_ptr _free
100002048 POINTER 64 DYLDINFO  __DATA.__la_symbol_ptr _fwrite
...
</pre></div></div><p>Using this representation, we can update relocations by adding the shift size to the <a class="reference internal"href=../formats/macho/python.html#lief.MachO.Relocation.address title=lief.MachO.Relocation.address><code class="xref py py-attr docutils literal notranslate"><span class=pre>lief.MachO.Relocation.address</span></code></a> attribute.<p>When the Mach-O builder reconstructs the final binary, it <strong>regenerates</strong> and optimize the rebase bytecode according to the current state of the relocations. The process can be summed up with the following diagram:<figure class=align-center><img alt=../_images/lief_bytecode.png src=../_images/lief_bytecode.png></figure></section><section id=binding-bytecode><h3 id=binding-bytecode>Binding bytecode<a title="Link to this heading"class=headerlink href=#binding-bytecode>¶</a></h3><p>The Mach-O loader also uses a bytecode to bind imported functions or imported symbols. Actually, this bytecode is used in three different binding methods:<ul class=simple><li><p>Normal binding<li><p>Weak binding – Used when the same symbol is defined multiple times<li><p>Lazy binding – Bound only when there is an access to the symbol</ul><p>The bytecode can be pretty printed with the <a class="reference internal"href=../formats/macho/python.html#lief.MachO.DyldInfo.show_bind_opcodes title=lief.MachO.DyldInfo.show_bind_opcodes><code class="xref py py-attr docutils literal notranslate"><span class=pre>show_bind_opcodes</span></code></a>, <a class="reference internal"href=../formats/macho/python.html#lief.MachO.DyldInfo.show_weak_bind_opcodes title=lief.MachO.DyldInfo.show_weak_bind_opcodes><code class="xref py py-attr docutils literal notranslate"><span class=pre>show_weak_bind_opcodes</span></code></a> and <a class="reference internal"href=../formats/macho/python.html#lief.MachO.DyldInfo.show_lazy_bind_opcodes title=lief.MachO.DyldInfo.show_lazy_bind_opcodes><code class="xref py py-attr docutils literal notranslate"><span class=pre>show_lazy_bind_opcodes</span></code></a>:<div class="highlight-python notranslate"><div class=highlight><pre><span></span><span class=nb>print</span><span class=p>(</span><span class=n>app</span><span class=o>.</span><span class=n>dyld_info</span><span class=o>.</span><span class=n>show_bind_opcodes</span><span class=p>)</span>
</pre></div></div><div class="highlight-text notranslate"><div class=highlight><pre><span></span>[SET_DYLIB_ORDINAL_IMM]
    Library Ordinal := 1
[SET_SYMBOL_TRAILING_FLAGS_IMM]
    Symbol name := ___stderrp
    Is Weak ? false
[SET_TYPE_IMM]
    Type := POINTER
[SET_SEGMENT_AND_OFFSET_ULEB]
    Segment := __DATA
    Segment Offset := 0x10
[DO_BIND]
    bind(POINTER, __DATA, 0x10, ___stderrp, library_ordinal=/usr/lib/libSystem.B.dylib, addend=0, is_weak_import=false)
    Segment Offset += 0x8 (0x18)
</pre></div></div><p>The representation and the update process is the same as the one described in the section about <em>Rebase bytecode</em></section><section id=export-trie><h3 id=export-trie>Export Trie<a title="Link to this heading"class=headerlink href=#export-trie>¶</a></h3><p>Regarding exported functions and exported symbols, Mach-O format uses a <em>trie</em> structure to store export information. Trie offset and size are given in the <a class="reference internal"href=../formats/macho/python.html#lief.MachO.DyldInfo.export_trie title=lief.MachO.DyldInfo.export_trie><code class="xref py py-attr docutils literal notranslate"><span class=pre>export_trie</span></code></a> attribute.<p>Once parsed, trie entries are represented through the <a class="reference internal"href=../formats/macho/python.html#lief.MachO.ExportInfo title=lief.MachO.ExportInfo><code class="xref py py-class docutils literal notranslate"><span class=pre>ExportInfo</span></code></a> object and can be retrieved with the <a class="reference internal"href=../formats/macho/python.html#lief.MachO.Symbol.export_info title=lief.MachO.Symbol.export_info><code class="xref py py-attr docutils literal notranslate"><span class=pre>export_info</span></code></a> attribute.<div class="highlight-python notranslate"><div class=highlight><pre><span></span><span class=n>app</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=s2>"FAT_MachO_x86_x86-64_library_libdyld.dylib"</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>app</span><span class=o>.</span><span class=n>dyld_info</span><span class=o>.</span><span class=n>show_export_trie</span><span class=p>)</span>
</pre></div></div><div class="highlight-text notranslate"><div class=highlight><pre><span></span>...
_@off.0x17
    _N@off.0x21
        _NS@off.0x50
            _NSI@off.0x5d
                _NSInstallLinkEditErrorHandlers@off.0x11d
                _NSInstallLinkEditErrorHandlers{addr: 0x126b, flags: 0}
...
</pre></div></div><div class="highlight-python notranslate"><div class=highlight><pre><span></span><span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>app</span><span class=o>.</span><span class=n>symbols</span><span class=p>:</span>
  <span class=k>if</span> <span class=n>s</span><span class=o>.</span><span class=n>has_export_info</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>s</span><span class=o>.</span><span class=n>export_info</span><span class=p>)</span>
</pre></div></div><div class="highlight-text notranslate"><div class=highlight><pre><span></span>Node Offset: 128
Flags:       0
Address:     126b
Symbol:      _NSInstallLinkEditErrorHandlers

Node Offset: 5f6
Flags:       0
Address:     2168
Symbol:      _NSIsSymbolDefinedInObjectFileImage

Node Offset: 1a0
Flags:       0
Address:     1391
Symbol:      _NSIsSymbolNameDefined
...
</pre></div></div><p>After the shift operation, export information are patched by updating the <a class="reference internal"href=../formats/macho/python.html#lief.MachO.ExportInfo.address title=lief.MachO.ExportInfo.address><code class="xref py py-attr docutils literal notranslate"><span class=pre>address</span></code></a> attribute, then a new export trie is generated from the previous updates.</section></section><section id=removing-signature><h2 id=removing-signature>Removing signature<a title="Link to this heading"class=headerlink href=#removing-signature>¶</a></h2><p>Removing the <code class="docutils literal notranslate"><span class=pre>LC_CODE_SIGNATURE</span></code> command is a basic modification that is pretty useful when modifying Mach-O file. Since the signature checks the integrity of the binary, we usually need to remove this command after modification on the file. We can still re-sign the binary once all modifications finished.<p>LIEF provides the <a class="reference internal"href=../formats/macho/python.html#lief.MachO.Binary.remove_signature title=lief.MachO.Binary.remove_signature><code class="xref py py-meth docutils literal notranslate"><span class=pre>lief.MachO.Binary.remove_signature()</span></code></a> function to remove this command:<div class="highlight-python notranslate"><div class=highlight><pre><span></span><span class=n>ssh</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=s2>"/usr/bin/ssh"</span><span class=p>)</span>

<span class=n>ssh</span><span class=o>.</span><span class=n>remove_signature</span><span class=p>()</span>

<span class=n>ssh</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>"ssh.nosigned"</span><span class=p>)</span>
</pre></div></div></section><section id=code-injection-with-shared-libraries><h2 id=code-injection-with-shared-libraries>Code Injection with shared libraries<a title="Link to this heading"class=headerlink href=#code-injection-with-shared-libraries>¶</a></h2><p>As explained in the talk about format modification <a class="footnote-reference brackets"href=#id4 id=id1 role=doc-noteref><span class=fn-bracket>[</span>1<span class=fn-bracket>]</span></a>, one way to inject code within the memory space of a program is to force the loader to load a library (that was not previously linked) that contains a constructor function.<p>For a Mach-O binary, it can be achieved by adding one of these load commands:<ul class=simple><li><p><a class="reference internal"href=../formats/macho/python.html#lief.MachO.LoadCommand.TYPE.ID_DYLIB title=lief.MachO.LoadCommand.TYPE.ID_DYLIB><code class="xref py py-attr docutils literal notranslate"><span class=pre>ID_DYLIB</span></code></a><li><p><a class="reference internal"href=../formats/macho/python.html#lief.MachO.LoadCommand.TYPE.LOAD_DYLIB title=lief.MachO.LoadCommand.TYPE.LOAD_DYLIB><code class="xref py py-attr docutils literal notranslate"><span class=pre>LOAD_DYLIB</span></code></a><li><p>…</ul><p>Let’s take an example with <code class="docutils literal notranslate"><span class=pre>clang</span></code>. First, we need to create a tiny library which defines a constructor:<div class="highlight-cpp notranslate"><div class=highlight><pre><span></span><span class=cp>#include</span><span class=w> </span><span class=cpf>&LTstdio.h></span>
<span class=cp>#include</span><span class=w> </span><span class=cpf>&LTstdlib.h></span>

<span class=n>__attribute__</span><span class=p>((</span><span class=n>constructor</span><span class=p>))</span>
<span class=kt>void</span><span class=w> </span><span class=n>my_constructor</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=n>printf</span><span class=p>(</span><span class=s>"Hello World</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
<span class=p>}</span>
</pre></div></div><p>Which is complied with<div class="highlight-console notranslate"><div class=highlight><pre><span></span><span class=gp>$ </span>clang<span class=w> </span>-fPIC<span class=w> </span>-shared<span class=w> </span>libexample.c<span class=w> </span>-o<span class=w> </span>libexample.dylib
</pre></div></div><p>Then we add a new <a class="reference internal"href=../formats/macho/python.html#lief.MachO.LoadCommand.TYPE.LOAD_DYLIB title=lief.MachO.LoadCommand.TYPE.LOAD_DYLIB><code class="xref py py-attr docutils literal notranslate"><span class=pre>LOAD_DYLIB</span></code></a> using the <a class="reference internal"href=../formats/macho/python.html#lief.MachO.Binary.add_library title=lief.MachO.Binary.add_library><code class="xref py py-meth docutils literal notranslate"><span class=pre>lief.MachO.Binary.add_library()</span></code></a> function:<div class="highlight-python notranslate"><div class=highlight><pre><span></span><span class=kn>import</span> <span class=nn>lief</span>
<span class=n>clang</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=s2>"/usr/bin/clang"</span><span class=p>)</span>

<span class=n>clang</span><span class=o>.</span><span class=n>add_library</span><span class=p>(</span><span class=s2>"/Users/romain/libexample.dylib"</span><span class=p>)</span>

<span class=n>clang</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>"/tmp/clang.new"</span><span class=p>)</span>
</pre></div></div><p>Finally, we run <code class="docutils literal notranslate"><span class=pre>clang.new</span></code> and see that <code class="docutils literal notranslate"><span class=pre>Hello</span> <span class=pre>World</span></code> is printed before the main execution of clang:<div class="highlight-console notranslate"><div class=highlight><pre><span></span><span class=gp>$ </span>chmod<span class=w> </span>u+x<span class=w> </span>/tmp/clang.new

<span class=gp>$ </span>/tmp/clang.new
<span class=go>Hello World</span>
<span class=go>clang: error: no input files</span>
</pre></div></div><p>We can also observe the new <a class="reference internal"href=../formats/macho/python.html#lief.MachO.LoadCommand.TYPE.LOAD_DYLIB title=lief.MachO.LoadCommand.TYPE.LOAD_DYLIB><code class="xref py py-attr docutils literal notranslate"><span class=pre>LOAD_DYLIB</span></code></a> command with otool:<div class="highlight-console notranslate"><div class=highlight><pre><span></span><span class=gp>$ </span>otool<span class=w> </span>-l<span class=w> </span>/tmp/clang.new<span class=p>|</span>grep<span class=w> </span>-C4<span class=w> </span>LOAD_DYLIB

<span class=go>...</span>
<span class=go>cmdsize 16</span>
<span class=go>dataoff 73864</span>
<span class=go>datasize 0</span>
<span class=go>Load command 16</span>
<span class=go>        cmd LC_LOAD_DYLIB</span>
<span class=go>    cmdsize 56</span>
<span class=go>       name /Users/romain/libexample.dylib (offset 24)</span>
<span class=go> time stamp 2 Thu Jan  1 01:00:02 1970</span>
<span class=go>    current version 0.0.0</span>
</pre></div></div></section><section id=adding-section-segment><h2 id=adding-section-segment>Adding Section/Segment<a title="Link to this heading"class=headerlink href=#adding-section-segment>¶</a></h2><p>As we can allocate arbitrary space between the load command table and the raw data, we can also extend an existing <a class="reference internal"href=../formats/macho/python.html#lief.MachO.LoadCommand title=lief.MachO.LoadCommand><code class="xref py py-class docutils literal notranslate"><span class=pre>LoadCommand</span></code></a>. Especially, Mach-O segments are commands that are associated with the LIEF object <a class="reference internal"href=../formats/macho/python.html#lief.MachO.SegmentCommand title=lief.MachO.SegmentCommand><code class="xref py py-class docutils literal notranslate"><span class=pre>lief.MachO.SegmentCommand</span></code></a>.<p>To add a new section in the <code class="docutils literal notranslate"><span class=pre>__TEXT</span></code> segment, we must extend the load command associated with this segment so that we can add a new section structure. We must also reserve space for the content of the section. As the content of the <code class="docutils literal notranslate"><span class=pre>__TEXT</span></code> segment begin at offset 0 and finish somewhere in the raw data, the right place to insert the new content is between the end of the load command table and the beginning of the raw data:<figure class=align-center><img alt=../_images/extendtxt.png src=../_images/extendtxt.png></figure><p>The process described above is implemented through the <a class="reference internal"href=../formats/macho/python.html#lief.MachO.Binary.add_section title=lief.MachO.Binary.add_section><code class="xref py py-meth docutils literal notranslate"><span class=pre>lief.MachO.Binary.add_section()</span></code></a> method.<p>Here is an example in which we will inject assembly code that executes <code class="docutils literal notranslate"><span class=pre>/bin/sh</span></code>:<div class="highlight-python notranslate"><div class=highlight><pre><span></span><span class=n>app</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=s2>"MachO64_x86-64_binary_id.bin"</span><span class=p>)</span>

<span class=n>raw_shell</span> <span class=o>=</span> <span class=p>[</span><span class=o>...</span><span class=p>]</span> <span class=c1># Assembly code</span>
<span class=n>section</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>MachO</span><span class=o>.</span><span class=n>Section</span><span class=p>(</span><span class=s2>"__shell"</span><span class=p>,</span> <span class=n>raw_shell</span><span class=p>)</span>

<span class=n>section</span><span class=o>.</span><span class=n>alignment</span> <span class=o>=</span> <span class=mi>2</span>
<span class=n>section</span> <span class=o>+=</span> <span class=n>lief</span><span class=o>.</span><span class=n>MachO</span><span class=o>.</span><span class=n>SECTION_FLAGS</span><span class=o>.</span><span class=n>SOME_INSTRUCTIONS</span>
<span class=n>section</span> <span class=o>+=</span> <span class=n>lief</span><span class=o>.</span><span class=n>MachO</span><span class=o>.</span><span class=n>SECTION_FLAGS</span><span class=o>.</span><span class=n>PURE_INSTRUCTIONS</span>

<span class=n>section</span> <span class=o>=</span> <span class=n>app</span><span class=o>.</span><span class=n>add_section</span><span class=p>(</span><span class=n>section</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>section</span><span class=p>)</span>
</pre></div></div><p>Then we can change the entry point by setting the <a class="reference internal"href=../formats/macho/python.html#lief.MachO.MainCommand.entrypoint title=lief.MachO.MainCommand.entrypoint><code class="xref py py-attr docutils literal notranslate"><span class=pre>lief.MachO.MainCommand.entrypoint</span></code></a> attribute:<div class="highlight-python notranslate"><div class=highlight><pre><span></span><span class=n>__TEXT</span> <span class=o>=</span> <span class=n>app</span><span class=o>.</span><span class=n>get_segment</span><span class=p>(</span><span class=s2>"__TEXT"</span><span class=p>)</span>
<span class=n>app</span><span class=o>.</span><span class=n>main_command</span><span class=o>.</span><span class=n>entrypoint</span> <span class=o>=</span> <span class=n>section</span><span class=o>.</span><span class=n>virtual_address</span> <span class=o>-</span> <span class=n>__TEXT</span><span class=o>.</span><span class=n>virtual_address</span>
</pre></div></div><p>Finally, we remove the signature and reconstruct the binary:<div class="highlight-python notranslate"><div class=highlight><pre><span></span><span class=n>app</span><span class=o>.</span><span class=n>remove_signature</span><span class=p>()</span>
<span class=n>app</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>"./id.modified"</span><span class=p>)</span>
</pre></div></div><p>The execution of <code class="docutils literal notranslate"><span class=pre>id.modified</span></code> should give a similar output:<div class="highlight-console notranslate"><div class=highlight><pre><span></span><span class=gp>Mac-mini:tmp romain$ </span>./id.modified
<span class=go>tmp @ [romain] $</span>
</pre></div></div><p>You can also check other tools such as optool <a class="footnote-reference brackets"href=#id5 id=id2 role=doc-noteref><span class=fn-bracket>[</span>2<span class=fn-bracket>]</span></a> or insert_dylib <a class="footnote-reference brackets"href=#id6 id=id3 role=doc-noteref><span class=fn-bracket>[</span>3<span class=fn-bracket>]</span></a><p class=rubric>References<aside class="footnote-list brackets"><aside class="footnote brackets"id=id4 role=doc-footnote><span class=label><span class=fn-bracket>[</span><a href=#id1 role=doc-backlink>1</a><span class=fn-bracket>]</span></span><p><a class="reference external"href=https://www.romainthomas.fr/publication/static-instrumentation/>https://www.romainthomas.fr/publication/static-instrumentation/</a></aside><aside class="footnote brackets"id=id5 role=doc-footnote><span class=label><span class=fn-bracket>[</span><a href=#id2 role=doc-backlink>2</a><span class=fn-bracket>]</span></span><p><a class="reference external"href=https://github.com/alexzielenski/optool>https://github.com/alexzielenski/optool</a></aside><aside class="footnote brackets"id=id6 role=doc-footnote><span class=label><span class=fn-bracket>[</span><a href=#id3 role=doc-backlink>3</a><span class=fn-bracket>]</span></span><p><a class="reference external"href=https://github.com/Tyilo/insert_dylib>https://github.com/Tyilo/insert_dylib</a></aside></aside><p class=rubric>API<ul class=simple><li><p><a class="reference internal"href=../formats/macho/python.html#lief.MachO.Binary.add_section title=lief.MachO.Binary.add_section><code class="xref py py-meth docutils literal notranslate"><span class=pre>lief.MachO.Binary.add_section()</span></code></a><li><p><a class="reference internal"href=../formats/macho/python.html#lief.MachO.Binary.add_library title=lief.MachO.Binary.add_library><code class="xref py py-meth docutils literal notranslate"><span class=pre>lief.MachO.Binary.add_library()</span></code></a></ul></section></section></div><div class="col-xl-2 d-none d-xl-block px-0 py-5 docs-sidebar docs-sidebar-right"><aside class="border-left pl-5 py-3"><span class="text-uppercase text-muted font-size-sm d-block mb-3"> On this page: </span><a class="d-block my-2"data-toggle=scroll href=#introduction>Introduction</a><a class="d-block my-2"data-toggle=scroll href=#when-pie-makes-thing-easier>When PIE makes thing easier</a><a class="d-block my-2"data-toggle=scroll href=#when-mach-o-makes-thing-harder>When Mach-O makes thing harder</a><a class="d-block my-2"data-toggle=scroll href=#removing-signature>Removing signature</a><a class="d-block my-2"data-toggle=scroll href=#code-injection-with-shared-libraries>Code Injection with shared libraries</a><a class="d-block my-2"data-toggle=scroll href=#adding-section-segment>Adding Section/Segment</a></aside></div></div></div>